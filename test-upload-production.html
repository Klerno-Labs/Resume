<!DOCTYPE html>
<html>
<head>
    <title>Upload Test - RewriteMe</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .container { border: 2px solid #ccc; padding: 20px; border-radius: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        #log { background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Upload Test Tool</h1>
        <p>This page tests if file uploads work on your account.</p>

        <div class="status info">
            <strong>Testing URL:</strong> https://rewriteme.app/api/resumes/upload
        </div>

        <h3>Step 1: Login Status</h3>
        <button onclick="checkAuth()">Check Authentication</button>
        <div id="authStatus"></div>

        <h3>Step 2: Upload File</h3>
        <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt">
        <button onclick="testUpload()">Test Upload</button>

        <h3>Debug Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function checkAuth() {
            log('Checking authentication...', 'info');
            const authDiv = document.getElementById('authStatus');

            try {
                const response = await fetch('https://rewriteme.app/api/auth/me', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    authDiv.innerHTML = `<div class="status success">
                        ✅ Authenticated as: ${data.user.email}<br>
                        Plan: ${data.user.plan}<br>
                        Credits: ${data.user.creditsRemaining}
                    </div>`;
                    log(`✅ Authenticated as ${data.user.email} (${data.user.plan}, ${data.user.creditsRemaining} credits)`, 'success');
                } else {
                    authDiv.innerHTML = `<div class="status error">
                        ❌ Not authenticated. Please <a href="https://rewriteme.app/auth">login first</a>.
                    </div>`;
                    log(`❌ Not authenticated (${response.status})`, 'error');
                }
            } catch (error) {
                authDiv.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
                log(`❌ Error checking auth: ${error.message}`, 'error');
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            log(`Starting upload: ${file.name} (${file.type}, ${file.size} bytes)`, 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                log('Sending POST request to /api/resumes/upload...', 'info');

                const response = await fetch('https://rewriteme.app/api/resumes/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log(`Response data: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    log(`✅ SUCCESS! Resume ID: ${data.resumeId}`, 'success');
                    alert(`✅ Upload successful! Resume ID: ${data.resumeId}\n\nRedirect to: https://rewriteme.app/editor?resumeId=${data.resumeId}`);
                } else {
                    log(`❌ FAILED: ${data.error || data.message}`, 'error');
                    alert(`❌ Upload failed: ${data.error || data.message}`);
                }
            } catch (error) {
                log(`❌ Network error: ${error.message}`, 'error');
                alert(`❌ Error: ${error.message}`);
            }
        }

        // Auto-check auth on page load
        window.onload = () => {
            log('Test tool loaded. Click "Check Authentication" to verify login.', 'info');
        };
    </script>
</body>
</html>
