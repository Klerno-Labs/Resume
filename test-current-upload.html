<!DOCTYPE html>
<html>
<head>
    <title>Upload Test - Current Production State</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        input, button { margin: 10px 0; padding: 8px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 3px solid #007bff; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>üîç Upload Diagnostic Tool - Production Test</h1>

    <div class="section">
        <h2>Step 1: Test Auth Status</h2>
        <button onclick="testAuth()">Check if logged in</button>
        <div id="auth-result"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test Upload</h2>
        <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt">
        <button onclick="testUpload()">Upload File</button>
        <div id="upload-result"></div>
    </div>

    <div class="section">
        <h2>Logs:</h2>
        <div id="logs"></div>
    </div>

    <script>
        const API_BASE = 'https://rewriteme.app/api';

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            console.log(message);
        }

        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<p>Testing...</p>';

            try {
                log('Testing /api/auth/me endpoint...');
                const response = await fetch(`${API_BASE}/auth/me`, {
                    credentials: 'include'
                });

                log(`Auth response status: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Authenticated as: ${data.user.email}`, 'success');
                    log(`Plan: ${data.user.plan}, Credits: ${data.user.creditsRemaining}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="success log">
                            ‚úÖ Logged in as: ${data.user.email}<br>
                            Plan: ${data.user.plan}<br>
                            Credits: ${data.user.creditsRemaining}
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    log(`‚ùå Not authenticated: ${error}`, 'error');
                    resultDiv.innerHTML = `<div class="error log">‚ùå Not logged in. Please login at https://rewriteme.app/auth first</div>`;
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error log">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('upload-result');

            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a file first');
                return;
            }

            const file = fileInput.files[0];
            resultDiv.innerHTML = '<p>Uploading...</p>';

            try {
                log(`üì§ Uploading file: ${file.name} (${file.size} bytes, ${file.type})`);

                const formData = new FormData();
                formData.append('file', file);

                log('Sending POST request to /api/resumes/upload...');
                const response = await fetch(`${API_BASE}/resumes/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                log(`Upload response status: ${response.status} ${response.statusText}`);
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);

                const responseText = await response.text();
                log(`Response body: ${responseText}`);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { rawResponse: responseText };
                }

                if (response.ok) {
                    log(`‚úÖ Upload successful! Resume ID: ${data.resumeId}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="success log">
                            ‚úÖ Upload successful!<br>
                            Resume ID: ${data.resumeId}<br>
                            Status: ${data.status}<br>
                            ${data.isDuplicate ? '‚ö†Ô∏è This is a duplicate upload' : ''}
                        </div>
                    `;
                } else {
                    log(`‚ùå Upload failed: ${JSON.stringify(data)}`, 'error');
                    resultDiv.innerHTML = `
                        <div class="error log">
                            ‚ùå Upload failed (${response.status})<br>
                            Error: ${data.error || data.message || responseText}
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error log">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-test auth on load
        window.onload = () => {
            log('üöÄ Diagnostic tool loaded');
            log('Testing authentication status...');
            testAuth();
        };
    </script>
</body>
</html>
