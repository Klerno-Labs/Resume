name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests with coverage
        run: npm run test -- --coverage
      - name: Start MinIO and Redis (for integration)
        uses: einaregilsson/mini-deploy@v0.3
        with:
          command: |
            docker run -d --name minio -p 9000:9000 -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin quay.io/minio/minio server /data
            docker run -d --name redis -p 6379:6379 redis:6
      - name: Wait for services
        run: |
          n=0; until nc -z localhost 9000 || [ $n -ge 15 ]; do n=$((n+1)); sleep 1; done
          n=0; until nc -z localhost 6379 || [ $n -ge 15 ]; do n=$((n+1)); sleep 1; done
      - name: Configure MinIO client (mc) and create bucket
        run: |
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          ./mc alias set local http://localhost:9000 minioadmin minioadmin
          ./mc mb local/resume-test || true
      - name: Run integration tests (MinIO)
        env:
          S3_BUCKET: resume-test
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        run: |
          # start worker in background
          node server/worker/processor.ts &
          # run integration tests
          npm run test:integration
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
